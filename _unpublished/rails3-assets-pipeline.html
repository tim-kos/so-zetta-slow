<p>Comecei a estudar Ruby on Rails há menos de duas semanas. Peguei o livro <a href="http://ruby.railstutorial.org/" target="_blank">Ruby on Rails 3 Tutorial: Learn by Example</a>, li e estou terminando o aplicativo desenvolvido ao longo dele. Foi bom: conheci o RSpec, brinquei com algumas gems (will paginate, faker, factory girl) e ainda aprendi a fazer algo com o rails. Bem produtivo.</p>

<p>Infelizmente, tive bastante problemas quando fui fazer o deploy (entenda como "hospedar e fazer funcionar") no <a href="http://www.heroku.com" target="_blank">heroku.com</a>. A primeira razão foi que <strong>esqueci</strong> de rodar o rake db:migrate no heroku:</p>

<code>heroku run rake db:migrate</code>

<p>(Precisa do <i>run</i> para funcionar no Cedar stack.)</p>

<p>O segundo foi bem simples também e envolveu colocar a gem do Postgre (banco de dados usado pelo heroku) no lugar da SQLite (padrão no rails). Bastou colocar o seguinte no Gemfile:</p>

<code>gem 'pg'</code>

<p>E retirar:</p>

<code>gem 'sqlite3'</code>

<p>Com isso, quase tudo funcionou. Mas eu ainda recebia aquele diabo "Application Error: An error occurred in the application and...". Fuçando nos logs, vi que o problema era que os meus arquivos JavaScript e CSS (presentes em app/assets/) <strong>não</strong> estavam sendo encontrados e isso gerava um erro que impedia o heroku de iniciar meu app. Pesquisando um pouco, descobri que a solução era um simples:</p>

<code>rake assets:precompile</code>

<p>Que "compila" meu application.js e outros arquivos para facilitar o <i>caching</i> dos mesmo. Você pode entender melhor como funciona o <i>asset pipeline</i> clicando <a href="http://guides.rubyonrails.org/asset_pipeline.html" target="_blank">neste link</a>.</p>

<p>Infelizmente, isso não foi o suficiente, o erro persistiu. Eu estava usando o framework CSS <a href="http://blueprintcss.org/" target="_blank">Blueprint</a>, recomendado pelo livro, e por alguma razão o rake ignorava esses arquivos. Depois de algumas horas fuçando no <a href="http://stackoverflow.com/questions/7300532/blueprint-css-rails-3-1-help" target="_blank">stackoverflow</a>, descobri o que fazer (a rigor, duas formas de resolver, uma gambiarra e a outra permanente).</p>

<p>Primeiramente, podemos forçar o rails a procurar os arquivos na assets pipeline em tempo de execução (runtime) mudando a seguinte configuração em config/environments/production.rb:</p>

<code>
# Don't fallback to assets pipeline if a precompiled asset is missed<br />
config.assets.compile = false
</code>

<p>Isso é uma "solução" ruim pois você perde performance ao pedir que o rails procure onde está o arquivo cada vez que uma página é requisitada. Ao invés disso, a solução definita que encontrei é adicionar a seguinte gem ao seu Gemfile (e usar bundle install depois):</p>

<code>gem 'therubyracer'</code>

<p>Depois adicionar a seguinte linha ao arquivo config/environments/production.rb:</p>

<code>config.assets.precompile += %w( *.css *.js )</code>

<p>E usar o comando <i>rake assets:precompile</i>. Depois disso, todos os arquivos JavaScript e CSS foram devidamente processados e colocados em public/assets/, fazendo com que o app funcionasse. Se quiser vê-lo, visite o site ou o repositório no github:</p>

<p><a href="http://strong-wind-7904.herokuapp.com/" target="_blank">http://strong-wind-7904.herokuapp.com/</a></p>
<p><a href="https://github.com/agarie/rails3-tutorial" target="_blank">https://github.com/agarie/rails3-tutorial</a></p>

<p>Qualquer dúvida ou sugestão, é só comentar. :)</p>